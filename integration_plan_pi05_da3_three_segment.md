# PI0.5 三段注意力（视觉+文本 / 几何 / 动作）接入规划

# PI0.5 几何注入（双 cross 方案）

目标：不改变现有 VLM/动作头数配置，保持视觉前缀/动作自注意力不变，动作通过两路 cross-attn 分别读取视觉+文本 KV 和几何 KV，几何不走动作 FFN/门控。

## 方案：动作自注意力 + 前缀 cross + 几何 cross
- 前缀（视觉+文本）：保持原自注意力/FFN。
- 动作：保持原自注意力/FFN。
- 几何：适配器输出后，独立几何 k/v 投影（自带可学习缩放 α），仅提供 KV，不参与动作 FFN。
- 融合：动作 query 先跨注意力读取前缀 KV，再跨注意力读取几何 KV（或并行计算后加和），再进动作 FFN/门控。
- cache：几何 KV 可固定不变（可复用），保持原有 cache 逻辑。

## 实施步骤（按序执行）
1) **新增几何 KV 模块**
   - 在动作侧注册 `geom_k_proj/geom_v_proj/geom_alpha`，输入为几何 token（对齐到动作或几何自定宽度），仅输出 k/v。
2) **动作层改为双 cross**
   - 保留动作自注意力不变。
   - 在动作 forward 中增加两路 cross-attn：动作 q -> 前缀 kv（已有逻辑）；动作 q -> 几何 kv（新逻辑，几何不进 FFN）。
   - 融合方式：两路 cross 输出相加或 concat+线性，再进动作 FFN。
3) **接口与 mask**
   - `PI05Pytorch.forward/sample_actions` 接收几何段，生成几何 pad/att/pos；几何不参与自注意力，只作为 cross-attn KV。
   - cache：保留原 cache，对几何 KV 可单独缓存或每步复用。
4) **测试验证**
   - 更新 `tools/test_three_segment_pi05.py` 调用双 cross 路径，检查前向/采样无报错、动作形状正常。
   - 小网格验证显存与收敛，必要时调低 α。

## 注意
- 不再强拼多段 KV，头数不需要强行一致；几何与前缀互不干扰，只通过动作查询聚合。
- 显存相对三段自注意力更可控；几何网格仍建议从小网格起步。
